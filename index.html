<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stage Management Show Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b0e12;
      --bg-elevated: #141922;
      --bg-elevated-soft: #181e29;
      --accent: #4ea3ff;
      --accent-soft: rgba(78, 163, 255, 0.12);
      --danger: #ff4e6a;
      --text-main: #f5f7fb;
      --text-muted: #9aa3b8;
      --border-subtle: #222a36;
      --shadow-soft: 0 14px 40px rgba(0, 0, 0, 0.45);
      --radius-lg: 12px;
      --radius-md: 8px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: radial-gradient(circle at top, #1d2736 0, #05060a 55%, #020308 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app-container {
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(145deg, rgba(16, 22, 33, 0.98), rgba(10, 13, 21, 0.98));
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(152, 191, 255, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 100vh;
    }

    header {
      padding: 18px 22px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(120deg, rgba(23, 40, 66, 0.9), rgba(11, 15, 24, 0.95));
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header h1 {
      font-size: 20px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.logo-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(78, 163, 255, 0.9);
    }

    header .subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill-indicator {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(13, 196, 135, 0.12);
      color: #7de9be;
      border: 1px solid rgba(125, 233, 190, 0.25);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    button {
      border: none;
      cursor: pointer;
      border-radius: var(--radius-md);
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.16s ease, transform 0.08s ease, box-shadow 0.16s ease, border-color 0.16s ease;
      white-space: nowrap;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-primary {
      padding: 8px 14px;
      background: radial-gradient(circle at top left, #63b0ff, #2674ff);
      color: #020308;
      font-weight: 600;
      box-shadow: 0 10px 24px rgba(11, 119, 255, 0.4);
    }

    .btn-primary:hover {
      background: radial-gradient(circle at top left, #72b8ff, #2f7dff);
      box-shadow: 0 12px 28px rgba(11, 119, 255, 0.55);
    }

    .btn-ghost {
      padding: 8px 14px;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius-pill);
      border: 1px solid rgba(99, 110, 136, 0.65);
    }

    .btn-ghost:hover {
      border-color: rgba(148, 159, 187, 0.95);
      color: var(--text-main);
      background: rgba(36, 46, 70, 0.5);
    }

    .main-layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 2.1fr);
      gap: 0;
      height: 100%;
      min-height: 0;
    }

    .pane {
      padding: 18px 20px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #39445a #101521;
    }

    .pane::-webkit-scrollbar {
      width: 8px;
    }
    .pane::-webkit-scrollbar-track {
      background: #101521;
    }
    .pane::-webkit-scrollbar-thumb {
      background: #374057;
      border-radius: 4px;
    }
    .pane::-webkit-scrollbar-thumb:hover {
      background: #4d5874;
    }

    .pane-left {
      border-right: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, #20283a 0, #111625 45%, #070a13 100%);
    }

    .pane-right {
      background: radial-gradient(circle at top right, #182033 0, #0d111c 45%, #060812 100%);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(116, 129, 158, 0.7);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 21, 33, 0.96), rgba(10, 13, 24, 0.96));
      border-radius: var(--radius-lg);
      padding: 12px 12px;
      border: 1px solid rgba(115, 138, 173, 0.4);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.55);
      margin-bottom: 14px;
    }

    .card-soft {
      background: radial-gradient(circle at top left, #171d29 0, #101522 40%, #080b13 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .pill-small {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(116, 129, 158, 0.75);
      color: var(--text-muted);
    }

    .show-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .show-item {
      padding: 8px 9px;
      border-radius: 10px;
      background: rgba(10, 13, 22, 0.9);
      border: 1px solid rgba(54, 65, 90, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.16s ease, border-color 0.16s ease, transform 0.08s ease;
    }

    .show-item:hover {
      background: rgba(25, 32, 49, 0.95);
      border-color: rgba(94, 134, 206, 0.9);
      transform: translateY(-1px);
    }

    .show-item-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .show-item-name {
      font-size: 14px;
      font-weight: 500;
    }

    .show-item-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #5dd89a;
      box-shadow: 0 0 10px rgba(93, 216, 154, 0.85);
    }

    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    label {
      font-size: 12px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="date"],
    textarea,
    select {
      background: #070b12;
      border-radius: 9px;
      border: 1px solid #252b3b;
      padding: 7px 9px;
      font-size: 14px;
      color: var(--text-main);
      outline: none;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(78, 163, 255, 0.5);
    }

    textarea {
      resize: vertical;
      min-height: 50px;
      max-height: 110px;
    }

    .timer-display {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 34px;
      letter-spacing: 0.12em;
      padding: 9px 12px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #151e2e, #070912);
      border: 1px solid rgba(120, 153, 225, 0.7);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      box-shadow: 0 18px 40px rgba(3, 9, 30, 0.8);
    }

    .timer-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .timer-state {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(105, 117, 151, 0.9);
      color: var(--text-muted);
    }

    .timer-controls {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-bottom: 10px;
    }

    .btn-timer-main {
      flex: 1;
      padding: 8px 10px;
      font-weight: 500;
      border-radius: 999px;
      border: 1px solid rgba(14, 182, 120, 0.9);
      background: radial-gradient(circle at top left, #2bd199, #079b60);
      color: #020307;
      box-shadow: 0 14px 30px rgba(4, 135, 86, 0.7);
    }

    .btn-timer-main.paused {
      background: radial-gradient(circle at top left, #4ea3ff, #2068f5);
      border-color: rgba(64, 132, 252, 0.95);
      box-shadow: 0 14px 30px rgba(19, 95, 221, 0.7);
    }

    .btn-small {
      padding: 7px 10px;
      font-size: 12px;
      border-radius: 999px;
      background: rgba(9, 14, 26, 0.9);
      border: 1px solid rgba(80, 92, 122, 0.85);
      color: var(--text-muted);
    }

    .btn-small:hover {
      border-color: rgba(124, 143, 184, 0.95);
      color: var(--text-main);
      background: rgba(24, 31, 51, 0.95);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff5c80, #ff2358);
      color: #020308;
      border-color: rgba(255, 124, 151, 0.9);
      box-shadow: 0 10px 24px rgba(255, 54, 98, 0.55);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #ff7492, #ff3466);
    }

    .pill-scene {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      background: rgba(24, 34, 59, 0.9);
      border: 1px solid rgba(92, 128, 199, 0.8);
      color: #b5c8ff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-scene span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #8ad1ff;
      box-shadow: 0 0 10px rgba(138, 209, 255, 0.9);
    }

    .scene-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
      max-height: 180px;
      overflow-y: auto;
      margin-top: 6px;
    }

    .scene-item {
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(7, 10, 18, 0.9);
      border: 1px solid rgba(47, 58, 84, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .scene-item-main {
      display: flex;
      flex-direction: column;
    }

    .scene-name {
      font-weight: 500;
    }

    .scene-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .tag {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(93, 109, 146, 0.95);
      color: var(--text-muted);
    }

    .notes-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .note-input-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .note-input {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .note-input input[type="text"] {
      flex: 1;
    }

    .note-log {
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      background: rgba(6, 9, 16, 0.95);
      border: 1px solid rgba(38, 46, 69, 0.95);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .note-item {
      padding: 5px 6px;
      border-radius: 7px;
      background: rgba(13, 19, 31, 0.95);
      border: 1px solid rgba(53, 64, 93, 0.95);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .note-text-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .note-timestamp {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: var(--text-muted);
    }

    .note-text {
      font-size: 12px;
    }

    .note-tag {
      align-self: flex-start;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(92, 115, 168, 0.95);
      color: var(--text-muted);
    }

    .showstop-log {
      max-height: 160px;
      overflow-y: auto;
      border-radius: 10px;
      background: rgba(20, 9, 14, 0.97);
      border: 1px solid rgba(116, 48, 71, 0.95);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .showstop-item {
      padding: 5px 6px;
      border-radius: 7px;
      background: rgba(38, 11, 23, 0.98);
      border: 1px solid rgba(150, 71, 99, 0.98);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .showstop-reason {
      font-size: 12px;
    }

    .showstop-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .report-section {
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(46, 55, 78, 0.9);
      padding-bottom: 8px;
    }

    .report-section:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    .report-section h3 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 5px;
    }

    .report-list {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .report-item-label {
      color: var(--text-muted);
    }

    .report-item-value {
      color: var(--text-main);
    }

    .tag-showstop {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(222, 102, 132, 0.95);
      color: #ffcede;
    }

    .link-button {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      color: var(--accent);
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
    }

    .link-button:hover {
      color: #81c2ff;
    }

    @media (max-width: 900px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      .pane-left {
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
      }
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="title-block">
        <h1>
          <span class="logo-dot"></span>
          Show Caller Console
        </h1>
        <div class="subtitle">Backstage timing, scenes, and notes — all in one place.</div>
      </div>
      <div class="header-actions">
        <div class="pill-indicator">Backstage dark mode</div>
        <button id="newShowBtn" class="btn-primary">
          <span>＋</span> Create New Show
        </button>
      </div>
    </header>

    <div class="main-layout">
      <!-- LEFT PANE: Shows + Timer/Controls -->
      <div class="pane pane-left">
        <div class="section-header">
          <div class="section-title">Shows</div>
          <span class="badge" id="showCountBadge">0 saved</span>
        </div>

        <div class="card-soft" id="newShowCard" style="display: none;">
          <div class="card-header">
            <div class="card-title">Create new show</div>
          </div>
          <div>
            <div class="form-row">
              <label for="showNameInput">Show name</label>
              <input type="text" id="showNameInput" placeholder="e.g. Wicked – Evening Performance" />
            </div>
            <div class="form-row">
              <label for="showDateInput">Show date</label>
              <input type="date" id="showDateInput" />
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 4px;">
              <button id="cancelNewShowBtn" class="btn-ghost">Cancel</button>
              <button id="saveNewShowBtn" class="btn-primary">Save &amp; Open</button>
            </div>
          </div>
        </div>

        <div class="card-soft">
          <div class="card-header">
            <div class="card-title">Saved shows</div>
            <span class="pill-small">Local only</span>
          </div>
          <div id="showList" class="show-list"></div>
          <div id="noShowsMessage" class="muted" style="margin-top: 4px;">
            No shows yet. Click <strong>Create New Show</strong> to get started.
          </div>
        </div>

        <div id="leftShowControls" style="display: none;">
          <div class="section-header" style="margin-top: 8px;">
            <div class="section-title" id="currentShowTitle"></div>
            <span class="badge" id="currentShowDate"></span>
          </div>

          <div class="card">
            <div class="timer-display">
              <div>
                <div class="timer-label">Show timer</div>
                <div id="timerValue">00:00:00</div>
              </div>
              <div>
                <div class="timer-state" id="timerStateBadge">Idle</div>
              </div>
            </div>

            <div class="timer-controls">
              <button id="toggleTimerBtn" class="btn-timer-main paused">Start</button>
              <button id="resetTimerBtn" class="btn-small">Reset</button>
              <button id="showStopBtn" class="btn-small btn-danger">Show stop</button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
              <button id="newSceneBtn" class="btn-small">
                ＋ New scene
              </button>
              <span class="pill-scene">
                <span class="dot"></span>
                <span id="sceneStatusLabel">No scenes yet</span>
              </span>
            </div>

            <div class="scene-list" id="sceneList"></div>
          </div>

          <div class="card-soft">
            <div class="card-header">
              <div class="card-title">Show stops</div>
              <span class="pill-small" id="showStopCountBadge">0</span>
            </div>
            <div id="showStopLog" class="showstop-log" style="display: none;"></div>
            <div id="noShowStopsMessage" class="muted">No show stops recorded.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANE: Notes + Report -->
      <div class="pane pane-right">
        <div class="section-header">
          <div class="section-title">Live notes &amp; report</div>
          <button id="toggleReportBtn" class="btn-ghost" style="display: none;">View report</button>
        </div>

        <div id="liveView">
          <div class="card-soft">
            <div class="card-header">
              <div class="card-title">Live notes</div>
              <span class="pill-small">Press Enter to save</span>
            </div>

            <div class="notes-container">
              <div class="note-input-row">
                <div class="note-input">
                  <input
                    type="text"
                    id="noteInput"
                    placeholder="Type a note and press Enter (e.g. 'LX 23 late by 1.2s')"
                  />
                  <button id="addNoteBtn" class="btn-small">Add</button>
                </div>
                <div class="muted">
                  Notes are automatically timestamped at the current show time.
                </div>
              </div>

              <div>
                <div class="card-header" style="margin-bottom: 4px;">
                  <div class="card-title">Note log</div>
                  <span class="pill-small" id="noteCountBadge">0</span>
                </div>
                <div id="noteLog" class="note-log">
                  <div class="muted">No notes yet. Start typing above.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card-soft">
            <div class="card-header">
              <div class="card-title">Quick summary</div>
            </div>
            <div class="report-list">
              <div>
                <span class="report-item-label">Current scene:</span>
                <span class="report-item-value" id="quickCurrentScene">None</span>
              </div>
              <div>
                <span class="report-item-label">Show stops:</span>
                <span class="report-item-value" id="quickShowStops">0</span>
              </div>
              <div>
                <span class="report-item-label">Notes:</span>
                <span class="report-item-value" id="quickNotesCount">0</span>
              </div>
            </div>
          </div>
        </div>

        <div id="reportView" style="display: none;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Show report</div>
              <button id="backToLiveBtn" class="btn-ghost">Back to live view</button>
            </div>
            <div id="reportContent">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Storage helpers ---
    const STORAGE_KEY = "showCaller_shows";

    function loadShows() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error("Failed to load shows:", e);
        return [];
      }
    }

    function saveShows(shows) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(shows));
    }

    // --- App state ---
    const appState = {
      shows: loadShows(),
      currentShowId: null,
      timer: {
        running: false,
        startTime: null,
        elapsed: 0, // in ms
        intervalId: null
      }
    };

    // --- Utility functions ---
    function formatTimeMs(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      const seconds = String(totalSeconds % 60).padStart(2, "0");
      return `${hours}:${minutes}:${seconds}`;
    }

    function getCurrentShow() {
      return appState.shows.find(s => s.id === appState.currentShowId) || null;
    }

    function updateShow(updatedShow) {
      const idx = appState.shows.findIndex(s => s.id === updatedShow.id);
      if (idx !== -1) {
        appState.shows[idx] = updatedShow;
        saveShows(appState.shows);
      }
    }

    function generateId() {
      return "show_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }

    // --- DOM elements ---
    const newShowBtn = document.getElementById("newShowBtn");
    const newShowCard = document.getElementById("newShowCard");
    const cancelNewShowBtn = document.getElementById("cancelNewShowBtn");
    const saveNewShowBtn = document.getElementById("saveNewShowBtn");
    const showNameInput = document.getElementById("showNameInput");
    const showDateInput = document.getElementById("showDateInput");
    const showList = document.getElementById("showList");
    const showCountBadge = document.getElementById("showCountBadge");
    const noShowsMessage = document.getElementById("noShowsMessage");
    const leftShowControls = document.getElementById("leftShowControls");
    const currentShowTitle = document.getElementById("currentShowTitle");
    const currentShowDate = document.getElementById("currentShowDate");

    const timerValue = document.getElementById("timerValue");
    const timerStateBadge = document.getElementById("timerStateBadge");
    const toggleTimerBtn = document.getElementById("toggleTimerBtn");
    const resetTimerBtn = document.getElementById("resetTimerBtn");
    const showStopBtn = document.getElementById("showStopBtn");
    const newSceneBtn = document.getElementById("newSceneBtn");
    const sceneStatusLabel = document.getElementById("sceneStatusLabel");
    const sceneListEl = document.getElementById("sceneList");

    const showStopLog = document.getElementById("showStopLog");
    const noShowStopsMessage = document.getElementById("noShowStopsMessage");
    const showStopCountBadge = document.getElementById("showStopCountBadge");

    const noteInput = document.getElementById("noteInput");
    const addNoteBtn = document.getElementById("addNoteBtn");
    const noteLog = document.getElementById("noteLog");
    const noteCountBadge = document.getElementById("noteCountBadge");

    const quickCurrentScene = document.getElementById("quickCurrentScene");
    const quickShowStops = document.getElementById("quickShowStops");
    const quickNotesCount = document.getElementById("quickNotesCount");

    const liveView = document.getElementById("liveView");
    const reportView = document.getElementById("reportView");
    const toggleReportBtn = document.getElementById("toggleReportBtn");
    const backToLiveBtn = document.getElementById("backToLiveBtn");
    const reportContent = document.getElementById("reportContent");

    const noShowsTextDefault =
      "No shows yet. Click <strong>Create New Show</strong> to get started.";

    // --- Rendering functions ---
    function renderShowsList() {
      showList.innerHTML = "";
      const shows = appState.shows.slice().sort((a, b) => {
        const da = a.date || "";
        const db = b.date || "";
        if (da === db) return (b.createdAt || 0) - (a.createdAt || 0);
        return db.localeCompare(da);
      });

      if (shows.length === 0) {
        noShowsMessage.innerHTML = noShowsTextDefault;
      } else {
        noShowsMessage.innerHTML =
          "Click a show to open it. All information is stored locally in this browser.";
      }

      showCountBadge.textContent = `${shows.length} saved`;

      shows.forEach(show => {
        const el = document.createElement("div");
        el.className = "show-item";
        el.innerHTML = `
          <div class="show-item-main">
            <div class="show-item-name">${show.name || "Untitled show"}</div>
            <div class="show-item-meta">
              <span>${show.date || "No date"}</span>
              <span>Scenes: ${show.scenes?.length || 0}</span>
              <span>Notes: ${show.notes?.length || 0}</span>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            ${
              appState.currentShowId === show.id
                ? '<span class="status-dot"></span><span class="muted">Active</span>'
                : '<span class="muted">Open</span>'
            }
          </div>
        `;
        el.addEventListener("click", () => {
          openShow(show.id);
        });
        showList.appendChild(el);
      });
    }

    function renderCurrentShowHeader() {
      const show = getCurrentShow();
      if (!show) {
        leftShowControls.style.display = "none";
        toggleReportBtn.style.display = "none";
        liveView.style.display = "block";
        reportView.style.display = "none";
        return;
      }

      leftShowControls.style.display = "block";
      toggleReportBtn.style.display = "inline-flex";

      currentShowTitle.textContent = show.name || "Untitled show";
      currentShowDate.textContent = show.date || "No date";

      const scenesCount = show.scenes?.length || 0;
      const notesCount = show.notes?.length || 0;
      const showStopsCount = show.showStops?.length || 0;

      showStopCountBadge.textContent = showStopsCount.toString();
      noteCountBadge.textContent = notesCount.toString();
      quickNotesCount.textContent = notesCount.toString();
      quickShowStops.textContent = showStopsCount.toString();

      if (scenesCount === 0) {
        sceneStatusLabel.textContent = "No scenes yet";
        quickCurrentScene.textContent = "None";
      } else {
        const currentScene = show.scenes[scenesCount - 1];
        sceneStatusLabel.textContent = `Scene ${currentScene.number}`;
        quickCurrentScene.textContent = `Scene ${currentScene.number}`;
      }
    }

    function renderTimer() {
      const ms = appState.timer.elapsed;
      timerValue.textContent = formatTimeMs(ms);
      if (appState.timer.running) {
        timerStateBadge.textContent = "Running";
        toggleTimerBtn.textContent = "Pause";
        toggleTimerBtn.classList.remove("paused");
      } else {
        timerStateBadge.textContent = ms === 0 ? "Idle" : "Paused";
        toggleTimerBtn.textContent = "Start";
        toggleTimerBtn.classList.add("paused");
      }
    }

    function renderScenes() {
      const show = getCurrentShow();
      if (!show) return;

      const scenes = show.scenes || [];
      sceneListEl.innerHTML = "";

      scenes.forEach(scene => {
        const el = document.createElement("div");
        el.className = "scene-item";
        const startLabel = formatTimeMs(scene.startTimeMs || 0);
        const endLabel =
          scene.endTimeMs != null ? formatTimeMs(scene.endTimeMs) : "…";
        const durationLabel =
          scene.endTimeMs != null
            ? formatTimeMs((scene.endTimeMs || 0) - (scene.startTimeMs || 0))
            : "";
        el.innerHTML = `
          <div class="scene-item-main">
            <div class="scene-name">Scene ${scene.number}</div>
            <div class="scene-meta">
              ${startLabel} → ${endLabel}
              ${
                durationLabel
                  ? ` &middot; <span class="muted">Dur: ${durationLabel}</span>`
                  : ""
              }
            </div>
          </div>
          <div>
            <span class="tag">Notes: ${scene.noteIds?.length || 0}</span>
          </div>
        `;
        sceneListEl.appendChild(el);
      });

      if (scenes.length === 0) {
        const el = document.createElement("div");
        el.className = "muted";
        el.textContent = "No scenes yet. Use 'New Scene' during the show.";
        sceneListEl.appendChild(el);
      }
    }

    function renderShowStops() {
      const show = getCurrentShow();
      if (!show) return;

      const stops = show.showStops || [];
      showStopCountBadge.textContent = stops.length.toString();
      quickShowStops.textContent = stops.length.toString();

      if (stops.length === 0) {
        showStopLog.style.display = "none";
        noShowStopsMessage.style.display = "block";
        return;
      }

      showStopLog.style.display = "flex";
      noShowStopsMessage.style.display = "none";
      showStopLog.innerHTML = "";

      stops.forEach(stop => {
        const el = document.createElement("div");
        el.className = "showstop-item";
        const startLabel = formatTimeMs(stop.startTimeMs || 0);
        const endLabel =
          stop.endTimeMs != null ? formatTimeMs(stop.endTimeMs) : "…";
        const durationLabel =
          stop.durationMs != null ? formatTimeMs(stop.durationMs) : "…";
        el.innerHTML = `
          <div class="showstop-reason">
            <span class="tag-showstop">Show stop</span>
            ${stop.reason ? " – " + stop.reason : ""}
          </div>
          <div class="showstop-meta">
            ${startLabel} → ${endLabel}
            &middot; Dur: ${durationLabel}
          </div>
        `;
        showStopLog.appendChild(el);
      });
    }

    function renderNotes() {
      const show = getCurrentShow();
      if (!show) return;

      const notes = show.notes || [];
      noteCountBadge.textContent = notes.length.toString();
      quickNotesCount.textContent = notes.length.toString();

      noteLog.innerHTML = "";
      if (notes.length === 0) {
        const el = document.createElement("div");
        el.className = "muted";
        el.textContent = "No notes yet. Start typing above.";
        noteLog.appendChild(el);
        return;
      }

      notes.forEach(note => {
        const el = document.createElement("div");
        el.className = "note-item";
        const tsLabel = formatTimeMs(note.timeMs || 0);
        el.innerHTML = `
          <div class="note-text-block">
            <div class="note-timestamp">${tsLabel}</div>
            <div class="note-text">${note.text}</div>
          </div>
        `;
        noteLog.appendChild(el);
      });
    }

    function renderReport() {
      const show = getCurrentShow();
      if (!show) {
        reportContent.innerHTML = "<div class='muted'>No show selected.</div>";
        return;
      }

      const totalRuntimeMs = appState.timer.elapsed;
      const scenes = show.scenes || [];
      const notes = show.notes || [];
      const stops = show.showStops || [];

      let html = "";

      html += `<div class="report-section">
        <h3>Show summary</h3>
        <div class="report-list">
          <div><span class="report-item-label">Show:</span> <span class="report-item-value">${show.name || "Untitled show"}</span></div>
          <div><span class="report-item-label">Date:</span> <span class="report-item-value">${show.date || "N/A"}</span></div>
          <div><span class="report-item-label">Total runtime:</span> <span class="report-item-value">${formatTimeMs(totalRuntimeMs)}</span></div>
          <div><span class="report-item-label">Scenes:</span> <span class="report-item-value">${scenes.length}</span></div>
          <div><span class="report-item-label">Show stops:</span> <span class="report-item-value">${stops.length}</span></div>
          <div><span class="report-item-label">Notes:</span> <span class="report-item-value">${notes.length}</span></div>
        </div>
      </div>`;

      html += `<div class="report-section">
        <h3>Scenes</h3>
        <div class="report-list">
          ${
            scenes.length === 0
              ? "<div class='muted'>No scenes recorded.</div>"
              : scenes
                  .map(scene => {
                    const startLabel = formatTimeMs(scene.startTimeMs || 0);
                    const endLabel =
                      scene.endTimeMs != null ? formatTimeMs(scene.endTimeMs) : "…";
                    const durationLabel =
                      scene.endTimeMs != null
                        ? formatTimeMs(
                            (scene.endTimeMs || 0) - (scene.startTimeMs || 0)
                          )
                        : "…";
                    return `<div>
                      <span class="report-item-label">Scene ${scene.number}:</span>
                      <span class="report-item-value">${startLabel} → ${endLabel} (Dur: ${durationLabel})</span>
                      <span class="muted"> &middot; Notes: ${scene.noteIds?.length || 0}</span>
                    </div>`;
                  })
                  .join("")
          }
        </div>
      </div>`;

      html += `<div class="report-section">
        <h3>Show stops</h3>
        <div class="report-list">
          ${
            stops.length === 0
              ? "<div class='muted'>No show stops recorded.</div>"
              : stops
                  .map(stop => {
                    const startLabel = formatTimeMs(stop.startTimeMs || 0);
                    const endLabel =
                      stop.endTimeMs != null ? formatTimeMs(stop.endTimeMs) : "…";
                    const durationLabel =
                      stop.durationMs != null
                        ? formatTimeMs(stop.durationMs)
                        : "…";
                    return `<div>
                      <span class="report-item-label">${startLabel} → ${endLabel}:</span>
                      <span class="report-item-value">${stop.reason || "No reason provided"}</span>
                      <span class="muted"> (Dur: ${durationLabel})</span>
                    </div>`;
                  })
                  .join("")
          }
        </div>
      </div>`;

      html += `<div class="report-section">
        <h3>Notes</h3>
        <div class="report-list">
          ${
            notes.length === 0
              ? "<div class='muted'>No notes recorded.</div>"
              : notes
                  .map(note => {
                    const tsLabel = formatTimeMs(note.timeMs || 0);
                    return `<div>
                      <span class="report-item-label">${tsLabel}:</span>
                      <span class="report-item-value">${note.text}</span>
                    </div>`;
                  })
                  .join("")
          }
        </div>
      </div>`;

      reportContent.innerHTML = html;
    }

    // --- Core actions ---
    function openNewShowForm() {
      newShowCard.style.display = "block";
      showNameInput.value = "";
      showDateInput.value = "";
      showNameInput.focus();
    }

    function closeNewShowForm() {
      newShowCard.style.display = "none";
    }

    function createShow() {
      const name = showNameInput.value.trim() || "Untitled show";
      const date = showDateInput.value || "";

      const newShow = {
        id: generateId(),
        name,
        date,
        createdAt: Date.now(),
        scenes: [],
        notes: [],
        showStops: []
      };

      appState.shows.push(newShow);
      saveShows(appState.shows);
      appState.currentShowId = newShow.id;
      appState.timer.elapsed = 0;
      appState.timer.running = false;
      clearInterval(appState.timer.intervalId);
      appState.timer.intervalId = null;
      renderAll();
      closeNewShowForm();
    }

    function openShow(showId) {
      appState.currentShowId = showId;
      const show = getCurrentShow();
      if (!show.timerElapsedMs) {
        appState.timer.elapsed = 0;
      } else {
        appState.timer.elapsed = show.timerElapsedMs;
      }
      appState.timer.running = false;
      clearInterval(appState.timer.intervalId);
      appState.timer.intervalId = null;
      liveView.style.display = "block";
      reportView.style.display = "none";
      renderAll();
    }

    function startTimer() {
      if (appState.timer.running) return;
      appState.timer.running = true;
      appState.timer.startTime = Date.now() - appState.timer.elapsed;
      appState.timer.intervalId = setInterval(() => {
        appState.timer.elapsed = Date.now() - appState.timer.startTime;
        const show = getCurrentShow();
        if (show) {
          show.timerElapsedMs = appState.timer.elapsed;
          updateShow(show);
        }
        renderTimer();
      }, 250);
      renderTimer();
    }

    function pauseTimer() {
      if (!appState.timer.running) return;
      appState.timer.running = false;
      clearInterval(appState.timer.intervalId);
      appState.timer.intervalId = null;
      appState.timer.elapsed = Date.now() - appState.timer.startTime;
      const show = getCurrentShow();
      if (show) {
        show.timerElapsedMs = appState.timer.elapsed;
        updateShow(show);
      }
      renderTimer();
    }

    function resetTimer() {
      if (appState.timer.running) {
        pauseTimer();
      }
      appState.timer.elapsed = 0;
      const show = getCurrentShow();
      if (show) {
        show.timerElapsedMs = 0;
        updateShow(show);
      }
      renderTimer();
    }

    function addScene() {
      const show = getCurrentShow();
      if (!show) return;

      const scenes = show.scenes || [];
      const number = scenes.length + 1;

      const nowMs = appState.timer.elapsed;
      const lastScene = scenes[scenes.length - 1];
      if (lastScene && lastScene.endTimeMs == null) {
        lastScene.endTimeMs = nowMs;
      }

      const newScene = {
        number,
        startTimeMs: nowMs,
        endTimeMs: null,
        noteIds: []
      };

      scenes.push(newScene);
      show.scenes = scenes;
      updateShow(show);
      renderScenes();
      renderCurrentShowHeader();
      renderReport();
    }

    function addShowStop() {
      const show = getCurrentShow();
      if (!show) return;

      const wasRunning = appState.timer.running;
      if (wasRunning) pauseTimer();

      const reason = window.prompt("Reason for show stop (optional):", "");
      const startMs = appState.timer.elapsed;

      // Simulate immediate stop/resume in one click.
      // For now, we log a 0-duration stop unless user waits then clicks OK.
      const resumeMs = appState.timer.elapsed;
      const durationMs = resumeMs - startMs;

      const newStop = {
        startTimeMs: startMs,
        endTimeMs: resumeMs,
        durationMs,
        reason: reason || ""
      };

      show.showStops = show.showStops || [];
      show.showStops.push(newStop);
      updateShow(show);
      renderShowStops();
      renderReport();

      if (wasRunning) startTimer();
    }

    function addNote() {
      const text = noteInput.value.trim();
      if (!text) return;
      const show = getCurrentShow();
      if (!show) return;

      const nowMs = appState.timer.elapsed;

      const newNote = {
        id: "note_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        timeMs: nowMs,
        text
      };

      show.notes = show.notes || [];
      show.notes.push(newNote);

      // link note to current scene if any
      const scenes = show.scenes || [];
      if (scenes.length > 0) {
        const currentScene = scenes[scenes.length - 1];
        currentScene.noteIds = currentScene.noteIds || [];
        currentScene.noteIds.push(newNote.id);
      }

      updateShow(show);
      noteInput.value = "";
      renderNotes();
      renderScenes();
      renderCurrentShowHeader();
      renderReport();
    }

    // --- Event listeners ---
    newShowBtn.addEventListener("click", openNewShowForm);
    cancelNewShowBtn.addEventListener("click", closeNewShowForm);
    saveNewShowBtn.addEventListener("click", createShow);

    toggleTimerBtn.addEventListener("click", () => {
      if (appState.timer.running) {
        pauseTimer();
      } else {
        startTimer();
      }
    });

    resetTimerBtn.addEventListener("click", resetTimer);
    newSceneBtn.addEventListener("click", addScene);
    showStopBtn.addEventListener("click", addShowStop);

    addNoteBtn.addEventListener("click", addNote);
    noteInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        addNote();
      }
    });

    toggleReportBtn.addEventListener("click", () => {
      liveView.style.display = "none";
      reportView.style.display = "block";
      renderReport();
    });

    backToLiveBtn.addEventListener("click", () => {
      liveView.style.display = "block";
      reportView.style.display = "none";
    });

    // --- Initial render ---
    function renderAll() {
      renderShowsList();
      renderCurrentShowHeader();
      renderTimer();
      renderScenes();
      renderShowStops();
      renderNotes();
    }

    renderAll();
  </script>
</body>
</html>

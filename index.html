<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Show Caller – Time & PDF Reports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- pdf-lib for filling the template PDF -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root {
      --bg: #05070d;
      --bg-elevated: #101521;
      --accent: #4ea3ff;
      --accent-soft: rgba(78, 163, 255, 0.15);
      --text-main: #f5f7fb;
      --text-muted: #9aa3b8;
      --border-subtle: #232a3a;
      --danger: #ff4e6a;
      --radius-lg: 12px;
      --radius-md: 9px;
      --radius-pill: 999px;
      --shadow-soft: 0 16px 38px rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1b2638 0, #02030a 55%, #010108 100%);
      color: var(--text-main);
      padding: 20px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(140deg, rgba(14, 20, 33, 0.98), rgba(7, 9, 16, 0.98));
      border-radius: 18px;
      border: 1px solid rgba(139, 176, 240, 0.18);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 100vh;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(120deg, #1c2740, #090c16);
    }

    .header-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .header-title h1 {
      font-size: 18px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(78, 163, 255, 0.8);
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill-indicator {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(111, 192, 255, 0.7);
      color: #a9d5ff;
      background: rgba(9, 39, 68, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .btn {
      border: none;
      cursor: pointer;
      border-radius: var(--radius-md);
      font-size: 13px;
      padding: 7px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.07s ease, background 0.16s ease, box-shadow 0.16s ease;
      white-space: nowrap;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: radial-gradient(circle at top left, #63b0ff, #236cff);
      color: #020308;
      font-weight: 600;
      box-shadow: 0 10px 22px rgba(18, 111, 239, 0.5);
      border-radius: var(--radius-pill);
    }

    .btn-primary:hover {
      background: radial-gradient(circle at top left, #70b8ff, #2b75ff);
    }

    .btn-ghost {
      background: transparent;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(94, 111, 151, 0.7);
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      border-color: rgba(134, 153, 197, 0.95);
      color: var(--text-main);
      background: rgba(29, 40, 66, 0.65);
    }

    .btn-small {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      background: rgba(7, 9, 17, 0.9);
      border: 1px solid rgba(73, 88, 122, 0.9);
      color: var(--text-muted);
    }

    .btn-small:hover {
      background: rgba(23, 29, 52, 0.95);
      color: var(--text-main);
      border-color: rgba(121, 141, 186, 0.95);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff5c80, #ff2358);
      border-color: rgba(255, 130, 153, 0.9);
      color: #020307;
      box-shadow: 0 10px 22px rgba(255, 60, 102, 0.6);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #ff708e, #ff3665);
    }

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
      min-height: 0;
    }

    .pane {
      padding: 16px 18px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #39445a #0a0e18;
    }

    .pane::-webkit-scrollbar {
      width: 8px;
    }
    .pane::-webkit-scrollbar-track {
      background: #05070f;
    }
    .pane::-webkit-scrollbar-thumb {
      background: #3a435f;
      border-radius: 4px;
    }

    .pane-left {
      border-right: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, #1c2435 0, #0b0f19 45%, #05060f 100%);
    }

    .pane-right {
      background: radial-gradient(circle at top right, #182033 0, #080b14 45%, #02030a 100%);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(95, 112, 151, 0.9);
      color: var(--text-muted);
    }

    .card {
      background: radial-gradient(circle at top left, #151b2a 0, #0b0f1b 45%, #050710 100%);
      border-radius: 14px;
      border: 1px solid rgba(82, 103, 152, 0.7);
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.6);
      padding: 12px 12px;
      margin-bottom: 12px;
    }

    .card-soft {
      background: rgba(9, 13, 24, 0.96);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-muted);
    }

    .muted {
      font-size: 12px;
      color: var(--text-muted);
    }

    .show-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .show-item {
      padding: 7px 9px;
      border-radius: 10px;
      background: rgba(5, 8, 16, 0.95);
      border: 1px solid rgba(50, 65, 99, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.16s ease, border-color 0.16s ease, transform 0.06s ease;
      font-size: 13px;
    }

    .show-item:hover {
      background: rgba(20, 29, 52, 0.96);
      border-color: rgba(101, 136, 211, 0.95);
      transform: translateY(-1px);
    }

    .show-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .show-name {
      font-weight: 500;
    }

    .show-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 6px;
    }

    .status-pill {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: var(--radius-pill);
      background: rgba(12, 28, 53, 0.98);
      border: 1px solid rgba(88, 146, 225, 0.95);
      color: #a9cdff;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #5ade9c;
      box-shadow: 0 0 10px rgba(81, 221, 151, 0.9);
    }

    .current-show-summary {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
    }

    .summary-label {
      color: var(--text-muted);
    }

    .summary-value {
      color: var(--text-main);
    }

    .timer-block {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .timer-display {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 32px;
      letter-spacing: 0.14em;
      padding: 8px 11px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #151e2e, #070912);
      border: 1px solid rgba(120, 153, 225, 0.7);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 18px 40px rgba(3, 9, 30, 0.8);
    }

    .timer-label-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .timer-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .timer-state {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(105, 117, 151, 0.9);
      color: var(--text-muted);
    }

    .timer-controls {
      display: flex;
      gap: 8px;
    }

    .btn-timer-main {
      flex: 1;
      border-radius: var(--radius-pill);
      padding: 8px 12px;
      font-weight: 500;
      border: 1px solid rgba(11, 178, 119, 0.9);
      background: radial-gradient(circle at top left, #2ad196, #079b60);
      color: #020306;
      box-shadow: 0 14px 30px rgba(4, 135, 86, 0.7);
    }

    .btn-timer-main.paused {
      background: radial-gradient(circle at top left, #4ea3ff, #2068f5);
      border-color: rgba(64, 132, 252, 0.95);
      box-shadow: 0 14px 30px rgba(19, 95, 221, 0.7);
    }

    .form-row {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 12px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea {
      background: #060812;
      border-radius: 9px;
      border: 1px solid #252b3b;
      padding: 7px 10px;
      font-size: 14px;
      color: var(--text-main);
      outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(78, 163, 255, 0.4);
    }

    textarea {
      resize: vertical;
      min-height: 40px;
      max-height: 90px;
    }

    .notes-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .notes-category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .notes-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-muted);
    }

    .note-log {
      margin-top: 5px;
      max-height: 120px;
      overflow-y: auto;
      padding: 6px;
      border-radius: 9px;
      background: rgba(5, 8, 16, 0.96);
      border: 1px solid rgba(37, 46, 72, 0.95);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .note-item {
      padding: 4px 5px;
      border-radius: 7px;
      background: rgba(12, 18, 30, 0.96);
      border: 1px solid rgba(52, 63, 93, 0.95);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .note-time {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: var(--text-muted);
    }

    .note-text {
      font-size: 11px;
    }

    .inline-pill {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(93, 109, 146, 0.95);
      color: var(--text-muted);
    }

    .report-preview {
      font-size: 12px;
      line-height: 1.4;
    }

    .report-preview h3 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .report-preview-section {
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px dashed rgba(57, 69, 108, 0.7);
    }

    .report-preview-section:last-child {
      border-bottom: none;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .pane-left {
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
      }
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-title">
        <h1><span class="logo-dot"></span> Show Caller PDF Console</h1>
        <div class="header-subtitle">
          Granny Got Stuck In The Time Machine – timing, notes, and auto‑generated PDF reports.
        </div>
      </div>
      <div class="header-actions">
        <div class="pill-indicator">Backstage dark mode</div>
        <button id="newRunBtn" class="btn-primary">＋ New performance</button>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: Reports & saved shows -->
      <div class="pane pane-left">
        <div class="section-header">
          <div class="section-title">Saved performance reports</div>
          <span id="showCountBadge" class="badge">0 saved</span>
        </div>

        <div class="card-soft">
          <div class="card-header">
            <div class="card-title">Performances</div>
            <span class="badge">Local storage</span>
          </div>
          <div id="showList" class="show-list"></div>
          <div id="noShows" class="muted" style="margin-top:6px;">
            No performances yet. Click <strong>New performance</strong> to start timing a show.
          </div>
        </div>

        <div id="reportCard" class="card-soft" style="display:none;">
          <div class="card-header">
            <div class="card-title">Selected performance</div>
            <button id="downloadPdfBtn" class="btn-small">Generate PDF report</button>
          </div>
          <div id="reportPreview" class="report-preview"></div>
        </div>
      </div>

      <!-- RIGHT: Live show controls -->
      <div class="pane pane-right">
        <div class="section-header">
          <div class="section-title">Live show controls</div>
          <span class="badge" id="liveStatusBadge">Idle</span>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Performance details</div>
            <span class="inline-pill">Show: Granny Got Stuck In The Time Machine</span>
          </div>
          <div class="form-row">
            <label for="perfNumberInput">Performance number</label>
            <input type="number" id="perfNumberInput" min="1" placeholder="e.g. 1" />
          </div>
          <div class="form-row">
            <label for="showNumberInput">Show number / internal ID (optional)</label>
            <input type="text" id="showNumberInput" placeholder="e.g. Evening 1, Matinee 2" />
          </div>
          <div class="form-row">
            <label for="dateInput">Date</label>
            <input type="date" id="dateInput" />
          </div>
          <div class="current-show-summary" style="margin-top:4px;">
            <div class="summary-row">
              <span class="summary-label">Current scene:</span>
              <span class="summary-value">Scene 1</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Notes (total):</span>
              <span class="summary-value" id="liveNotesTotal">0</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Show timer</div>
          </div>
          <div class="timer-block">
            <div class="timer-display">
              <div class="timer-label-block">
                <div class="timer-label">Runtime</div>
                <div id="timerValue">00:00:00</div>
              </div>
              <div class="timer-state" id="timerState">Idle</div>
            </div>
            <div class="timer-controls">
              <button id="toggleTimerBtn" class="btn-timer-main paused">Start show</button>
              <button id="pauseTimerBtn" class="btn-small">Pause</button>
              <button id="stopShowBtn" class="btn-small btn-danger">Stop show</button>
            </div>
            <div class="muted">
              Scene 1 starts automatically when you press <strong>Start show</strong>. Use <strong>Stop show</strong> to end
              and generate the report.
            </div>
          </div>
        </div>

        <div class="card-soft">
          <div class="card-header">
            <div class="card-title">Notes</div>
            <span class="inline-pill" id="notesSummaryBadge">0 total notes</span>
          </div>
          <div class="notes-grid">
            <!-- General -->
            <div>
              <div class="notes-category-header">
                <div class="notes-title">General</div>
                <span class="badge" id="countGeneral">0</span>
              </div>
              <textarea id="inputGeneral" placeholder="Type a general note and press Enter (while focused)"></textarea>
              <div class="note-log" id="logGeneral">
                <div class="muted">No general notes yet.</div>
              </div>
            </div>
            <!-- Technical -->
            <div>
              <div class="notes-category-header">
                <div class="notes-title">Technical</div>
                <span class="badge" id="countTechnical">0</span>
              </div>
              <textarea id="inputTechnical" placeholder="LX, SD, AV, automation issues..."></textarea>
              <div class="note-log" id="logTechnical">
                <div class="muted">No technical notes yet.</div>
              </div>
            </div>
            <!-- Cast -->
            <div>
              <div class="notes-category-header">
                <div class="notes-title">Cast</div>
                <span class="badge" id="countCast">0</span>
              </div>
              <textarea id="inputCast" placeholder="Cast performance, line issues, covers..."></textarea>
              <div class="note-log" id="logCast">
                <div class="muted">No cast notes yet.</div>
              </div>
            </div>
            <!-- Accident -->
            <div>
              <div class="notes-category-header">
                <div class="notes-title">Accident report</div>
                <span class="badge" id="countAccident">0</span>
              </div>
              <textarea id="inputAccident" placeholder="Incidents, injuries, H&S concerns..."></textarea>
              <div class="note-log" id="logAccident">
                <div class="muted">No accident notes yet.</div>
              </div>
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">
            While focused in a notes box, press <strong>Enter</strong> to save a note. Each note is timestamped with the
            current show time.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Storage ----------
    const STORAGE_KEY = "showCaller_pdf_performances";

    function loadPerformances() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function savePerformances(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    // ---------- State ----------
    const state = {
      performances: loadPerformances(),
      currentLive: {
        id: null,
        isRunning: false,
        startTime: null,
        elapsedMs: 0
      },
      timerInterval: null,
      selectedReportId: null
    };

    const SHOW_TITLE = "Granny Got Stuck In The Time Machine";

    // ---------- DOM ----------
    const showListEl = document.getElementById("showList");
    const showCountBadge = document.getElementById("showCountBadge");
    const noShowsEl = document.getElementById("noShows");
    const reportCard = document.getElementById("reportCard");
    const reportPreviewEl = document.getElementById("reportPreview");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");

    const newRunBtn = document.getElementById("newRunBtn");
    const perfNumberInput = document.getElementById("perfNumberInput");
    const showNumberInput = document.getElementById("showNumberInput");
    const dateInput = document.getElementById("dateInput");
    const liveStatusBadge = document.getElementById("liveStatusBadge");

    const timerValueEl = document.getElementById("timerValue");
    const timerStateEl = document.getElementById("timerState");
    const toggleTimerBtn = document.getElementById("toggleTimerBtn");
    const pauseTimerBtn = document.getElementById("pauseTimerBtn");
    const stopShowBtn = document.getElementById("stopShowBtn");

    const liveNotesTotalEl = document.getElementById("liveNotesTotal");
    const notesSummaryBadge = document.getElementById("notesSummaryBadge");

    const inputGeneral = document.getElementById("inputGeneral");
    const inputTechnical = document.getElementById("inputTechnical");
    const inputCast = document.getElementById("inputCast");
    const inputAccident = document.getElementById("inputAccident");

    const logGeneral = document.getElementById("logGeneral");
    const logTechnical = document.getElementById("logTechnical");
    const logCast = document.getElementById("logCast");
    const logAccident = document.getElementById("logAccident");

    const countGeneral = document.getElementById("countGeneral");
    const countTechnical = document.getElementById("countTechnical");
    const countCast = document.getElementById("countCast");
    const countAccident = document.getElementById("countAccident");

    // ---------- Util ----------
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const h = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      const s = String(totalSeconds % 60).padStart(2, "0");
      return `${h}:${m}:${s}`;
    }

    function totalNotesCount(notes) {
      return (
        (notes.general?.length || 0) +
        (notes.technical?.length || 0) +
        (notes.cast?.length || 0) +
        (notes.accident?.length || 0)
      );
    }

    function createEmptyNotes() {
      return {
        general: [],
        technical: [],
        cast: [],
        accident: []
      };
    }

    function getLivePerformance() {
      if (!state.currentLive.id) return null;
      return state.performances.find(p => p.id === state.currentLive.id) || null;
    }

    function updatePerformance(perf) {
      const idx = state.performances.findIndex(p => p.id === perf.id);
      if (idx === -1) return;
      state.performances[idx] = perf;
      savePerformances(state.performances);
    }

    // ---------- Rendering ----------
    function renderPerformancesList() {
      showListEl.innerHTML = "";
      const list = state.performances.slice().sort((a, b) => {
        const da = a.date || "";
        const db = b.date || "";
        if (da === db) return (b.createdAt || 0) - (a.createdAt || 0);
        return db.localeCompare(da);
      });

      showCountBadge.textContent = `${list.length} saved`;

      if (list.length === 0) {
        noShowsEl.style.display = "block";
      } else {
        noShowsEl.style.display = "block";
        noShowsEl.innerHTML =
          "Click a performance to view its summary and generate a PDF report.";
      }

      list.forEach(perf => {
        const el = document.createElement("div");
        el.className = "show-item";
        const runtimeLabel = perf.runtimeMs != null ? formatTime(perf.runtimeMs) : "--:--:--";
        const notesCount = totalNotesCount(perf.notes || createEmptyNotes());
        el.innerHTML = `
          <div class="show-left">
            <div class="show-name">
              Perf #${perf.performanceNumber || "?"} – ${perf.date || "No date"}
            </div>
            <div class="show-meta">
              <span>${SHOW_TITLE}</span>
              <span>Runtime: ${runtimeLabel}</span>
              <span>Notes: ${notesCount}</span>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            ${
              state.selectedReportId === perf.id
                ? '<span class="status-dot"></span><span class="muted">Selected</span>'
                : '<span class="muted">Open</span>'
            }
          </div>
        `;
        el.addEventListener("click", () => {
          state.selectedReportId = perf.id;
          renderPerformancesList();
          renderSelectedReport();
        });
        showListEl.appendChild(el);
      });
    }

    function renderTimer() {
      timerValueEl.textContent = formatTime(state.currentLive.elapsedMs);
      if (state.currentLive.isRunning) {
        timerStateEl.textContent = "Running";
        toggleTimerBtn.textContent = "Pause (main)";
        toggleTimerBtn.classList.remove("paused");
        liveStatusBadge.textContent = "Running";
      } else if (state.currentLive.elapsedMs === 0) {
        timerStateEl.textContent = "Idle";
        toggleTimerBtn.textContent = "Start show";
        toggleTimerBtn.classList.add("paused");
        liveStatusBadge.textContent = "Idle";
      } else {
        timerStateEl.textContent = "Paused";
        toggleTimerBtn.textContent = "Resume show";
        toggleTimerBtn.classList.add("paused");
        liveStatusBadge.textContent = "Paused";
      }
    }

    function renderNotesLogs(notes) {
      const cats = [
        { key: "general", logEl: logGeneral, countEl: countGeneral },
        { key: "technical", logEl: logTechnical, countEl: countTechnical },
        { key: "cast", logEl: logCast, countEl: countCast },
        { key: "accident", logEl: logAccident, countEl: countAccident }
      ];

      cats.forEach(cat => {
        const arr = notes[cat.key] || [];
        cat.countEl.textContent = arr.length.toString();
        cat.logEl.innerHTML = "";
        if (arr.length === 0) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = `No ${cat.key} notes yet.`;
          cat.logEl.appendChild(empty);
        } else {
          arr.forEach(n => {
            const item = document.createElement("div");
            item.className = "note-item";
            item.innerHTML = `
              <div class="note-time">${formatTime(n.timeMs || 0)}</div>
              <div class="note-text">${n.text}</div>
            `;
            cat.logEl.appendChild(item);
          });
        }
      });
    }

    function renderLiveNotesSummary() {
      const perf = getLivePerformance();
      if (!perf) {
        liveNotesTotalEl.textContent = "0";
        notesSummaryBadge.textContent = "0 total notes";
        return;
      }
      const count = totalNotesCount(perf.notes || createEmptyNotes());
      liveNotesTotalEl.textContent = count.toString();
      notesSummaryBadge.textContent = `${count} total notes`;
    }

    function renderSelectedReport() {
      const perf = state.performances.find(p => p.id === state.selectedReportId);
      if (!perf) {
        reportCard.style.display = "none";
        reportPreviewEl.innerHTML = "";
        return;
      }

      reportCard.style.display = "block";
      const notes = perf.notes || createEmptyNotes();
      const runtimeLabel = perf.runtimeMs != null ? formatTime(perf.runtimeMs) : "--:--:--";

      function notesToText(arr) {
        if (!arr || arr.length === 0) return "None.";
        return arr
          .map(n => `${formatTime(n.timeMs || 0)} – ${n.text}`)
          .join("\n");
      }

      reportPreviewEl.innerHTML = `
        <div class="report-preview-section">
          <h3>Performance info</h3>
          <div><strong>Date:</strong> ${perf.date || "N/A"}</div>
          <div><strong>Show:</strong> ${SHOW_TITLE}</div>
          <div><strong>Performance #:</strong> ${perf.performanceNumber || "N/A"}</div>
          <div><strong>Show number / ID:</strong> ${perf.showNumber || "N/A"}</div>
          <div><strong>Running time (Act I):</strong> ${runtimeLabel}</div>
        </div>

        <div class="report-preview-section">
          <h3>General comments</h3>
          <pre>${notesToText(notes.general)}</pre>
        </div>

        <div class="report-preview-section">
          <h3>Technical</h3>
          <pre>${notesToText(notes.technical)}</pre>
        </div>

        <div class="report-preview-section">
          <h3>Cast</h3>
          <pre>${notesToText(notes.cast)}</pre>
        </div>

        <div class="report-preview-section">
          <h3>Accident report</h3>
          <pre>${notesToText(notes.accident)}</pre>
        </div>
      `;
    }

    function renderAll() {
      renderPerformancesList();
      renderTimer();
      const perf = getLivePerformance();
      renderNotesLogs(perf ? perf.notes : createEmptyNotes());
      renderLiveNotesSummary();
      renderSelectedReport();
    }

    // ---------- Live performance flow ----------
    function startNewPerformance() {
      // If there is a running performance, stop its timer but don't auto-save.
      if (state.currentLive.isRunning && state.currentLive.id) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
        state.currentLive.isRunning = false;
      }

      const today = new Date();
      const iso = today.toISOString().slice(0, 10);
      dateInput.value = iso;

      const newPerf = {
        id: "perf_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        createdAt: Date.now(),
        date: iso,
        performanceNumber: "",
        showNumber: "",
        showTitle: SHOW_TITLE,
        runtimeMs: 0,
        notes: createEmptyNotes()
      };
      state.performances.push(newPerf);
      savePerformances(state.performances);

      state.currentLive.id = newPerf.id;
      state.currentLive.elapsedMs = 0;
      state.currentLive.isRunning = false;
      state.currentLive.startTime = null;
      state.selectedReportId = newPerf.id;

      perfNumberInput.value = "";
      showNumberInput.value = "";
      renderAll();
    }

    function syncFormToLivePerf() {
      const perf = getLivePerformance();
      if (!perf) return;
      perf.performanceNumber = perfNumberInput.value || "";
      perf.showNumber = showNumberInput.value || "";
      perf.date = dateInput.value || perf.date;
      updatePerformance(perf);
      renderPerformancesList();
      renderSelectedReport();
    }

    function startTimer() {
      if (state.currentLive.isRunning) return;
      const perf = getLivePerformance();
      if (!perf) return;

      syncFormToLivePerf();

      state.currentLive.isRunning = true;
      state.currentLive.startTime = Date.now() - state.currentLive.elapsedMs;

      if (state.timerInterval) clearInterval(state.timerInterval);
      state.timerInterval = setInterval(() => {
        state.currentLive.elapsedMs = Date.now() - state.currentLive.startTime;
        perf.runtimeMs = state.currentLive.elapsedMs;
        updatePerformance(perf);
        renderTimer();
      }, 250);
      renderTimer();
    }

    function pauseTimer() {
      if (!state.currentLive.isRunning) return;
      const perf = getLivePerformance();
      if (!perf) return;
      state.currentLive.isRunning = false;
      clearInterval(state.timerInterval);
      state.timerInterval = null;
      state.currentLive.elapsedMs = Date.now() - state.currentLive.startTime;
      perf.runtimeMs = state.currentLive.elapsedMs;
      updatePerformance(perf);
      renderTimer();
    }

    function stopShowAndSave() {
      const perf = getLivePerformance();
      if (!perf) return;

      if (state.currentLive.isRunning) {
        pauseTimer();
      }

      // Final sync of form fields
      syncFormToLivePerf();

      // Ensure runtime saved
      perf.runtimeMs = state.currentLive.elapsedMs;
      updatePerformance(perf);

      // Reset live state
      state.currentLive.id = null;
      state.currentLive.elapsedMs = 0;
      state.currentLive.isRunning = false;
      state.currentLive.startTime = null;

      perfNumberInput.value = "";
      showNumberInput.value = "";
      // Date remains but no link to a running show now.

      // Focus left column & generate PDF
      state.selectedReportId = perf.id;
      renderAll();
      generatePdfForPerformance(perf).catch(err => {
        console.error("PDF generation failed:", err);
        alert(
          "The PDF could not be generated. Check that 'Christmas Show Report Template.pdf' is in the same folder as index.html."
        );
      });
    }

    // ---------- Notes adding ----------
    function addNote(category, text) {
      const trimmed = text.trim();
      if (!trimmed) return;
      const perf = getLivePerformance();
      if (!perf) return;

      const perfNotes = perf.notes || createEmptyNotes();
      const nowMs = state.currentLive.elapsedMs || 0;
      const note = {
        timeMs: nowMs,
        text: trimmed
      };
      perfNotes[category].push(note);
      perf.notes = perfNotes;
      updatePerformance(perf);

      renderNotesLogs(perfNotes);
      renderLiveNotesSummary();
    }

    function setupNotesInput(textarea, category) {
      textarea.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          addNote(category, textarea.value);
          textarea.value = "";
        }
      });
    }

    // ---------- PDF generation ----------
    async function generatePdfForPerformance(perf) {
      const { PDFDocument, StandardFonts, rgb } = PDFLib;

      // Fetch template from repo root
      const existingPdfBytes = await fetch("Christmas Show Report Template.pdf").then(r =>
        r.arrayBuffer()
      );

      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const pages = pdfDoc.getPages();
      const page = pages[0];

      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
      const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
      const fontSize = 10;
      const black = rgb(0, 0, 0);

      const runtimeLabel = perf.runtimeMs != null ? formatTime(perf.runtimeMs) : "--:--:--";
      const notes = perf.notes || createEmptyNotes();

      function notesMultiLine(arr) {
        if (!arr || arr.length === 0) return "None.";
        return arr
          .map(n => `${formatTime(n.timeMs || 0)} – ${n.text}`)
          .join("\n");
      }

      // NOTE: The coordinates below are approximate and assume
      // the template is A4-ish and the boxes are in rough positions.
      // You can tweak x / y values if needed.

      // Top table: DATE | SHOW | PERF #
      page.drawText(perf.date || "", {
        x: 60,
        y: 735,
        size: fontSize,
        font,
        color: black
      });

      page.drawText(SHOW_TITLE, {
        x: 200,
        y: 735,
        size: fontSize,
        font,
        color: black
      });

      page.drawText(String(perf.performanceNumber || ""), {
        x: 410,
        y: 735,
        size: fontSize,
        font,
        color: black
      });

      // Running time (Act I)
      page.drawText(runtimeLabel, {
        x: 120,
        y: 705,
        size: fontSize,
        font,
        color: black
      });

      // Now notes sections. We’ll stack them roughly down the page.
      function drawWrappedText(text, x, y, width, lineHeight, useBold) {
        const lines = [];
        const words = text.split(/\s+/);
        let currentLine = "";
        words.forEach(word => {
          const testLine = currentLine ? currentLine + " " + word : word;
          const textWidth = (useBold ? fontBold : font).widthOfTextAtSize(testLine, fontSize);
          if (textWidth > width && currentLine) {
            lines.push(currentLine);
            currentLine = word;
          } else {
            currentLine = testLine;
          }
        });
        if (currentLine) lines.push(currentLine);

        let currentY = y;
        lines.forEach(line => {
          page.drawText(line, {
            x,
            y: currentY,
            size: fontSize,
            font: useBold ? fontBold : font,
            color: black
          });
          currentY -= lineHeight;
        });
        return currentY;
      }

      let cursorY = 660;

      // GENERAL COMMENTS
      cursorY = drawWrappedText("GENERAL COMMENTS:", 60, cursorY, 480, 14, true) - 4;
      cursorY = drawWrappedText(notesMultiLine(notes.general), 60, cursorY, 480, 12, false) - 10;

      // TECHNICAL
      cursorY = drawWrappedText("TECHNICAL:", 60, cursorY, 480, 14, true) - 4;
      cursorY = drawWrappedText(notesMultiLine(notes.technical), 60, cursorY, 480, 12, false) - 10;

      // CAST
      cursorY = drawWrappedText("CAST:", 60, cursorY, 480, 14, true) - 4;
      cursorY = drawWrappedText(notesMultiLine(notes.cast), 60, cursorY, 480, 12, false) - 10;

      // ACCIDENT REPORT
      cursorY = drawWrappedText("ACCIDENT REPORT:", 60, cursorY, 480, 14, true) - 4;
      drawWrappedText(notesMultiLine(notes.accident), 60, cursorY, 480, 12, false);

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      const safeDate = perf.date || "Performance";
      link.href = url;
      link.download = `Show Report - ${safeDate}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ---------- Event listeners ----------
    newRunBtn.addEventListener("click", startNewPerformance);

    perfNumberInput.addEventListener("change", syncFormToLivePerf);
    showNumberInput.addEventListener("change", syncFormToLivePerf);
    dateInput.addEventListener("change", syncFormToLivePerf);

    toggleTimerBtn.addEventListener("click", () => {
      if (state.currentLive.isRunning) pauseTimer();
      else startTimer();
    });

    pauseTimerBtn.addEventListener("click", () => {
      pauseTimer();
    });

    stopShowBtn.addEventListener("click", () => {
      if (!state.currentLive.id) {
        alert("No live performance is currently running.");
        return;
      }
      if (!confirm("Stop show and generate a performance report?")) return;
      stopShowAndSave();
    });

    setupNotesInput(inputGeneral, "general");
    setupNotesInput(inputTechnical, "technical");
    setupNotesInput(inputCast, "cast");
    setupNotesInput(inputAccident, "accident");

    downloadPdfBtn.addEventListener("click", () => {
      const perf = state.performances.find(p => p.id === state.selectedReportId);
      if (!perf) return;
      generatePdfForPerformance(perf).catch(err => {
        console.error("PDF generation failed:", err);
        alert(
          "The PDF could not be generated. Check that 'Christmas Show Report Template.pdf' is in the same folder as index.html."
        );
      });
    });

    // ---------- Initial render ----------
    renderAll();
  </script>
</body>
</html>
